apiVersion: camel.apache.org/v1
kind: Integration
metadata:
  name: kafka-to-datagrid-route
spec:
  configuration:
    - type: secret
      value: bobbycar-kafka2datagrid-secret
  sources:
    - content: "package com.redhat.bobbycar.routes;\nimport java.nio.charset.Charset;\n\nimport org.apache.camel.PropertyInject;\nimport org.apache.camel.builder.RouteBuilder;\nimport org.apache.camel.component.infinispan.InfinispanConstants;\nimport org.apache.camel.component.infinispan.InfinispanOperation;\nimport org.infinispan.client.hotrod.configuration.ClientIntelligence;\nimport org.infinispan.client.hotrod.configuration.Configuration;\nimport org.infinispan.client.hotrod.configuration.ConfigurationBuilder;\nimport org.infinispan.client.hotrod.configuration.SaslQop;\nimport org.infinispan.commons.marshall.StringMarshaller;\n\npublic class KafkaToDatagridRoute extends RouteBuilder {\n\t\n\t@PropertyInject(\"com.redhat.bobbycar.camelk.dg.host\")\n    private String datagridHost;\n\t@PropertyInject(value = \"com.redhat.bobbycar.camelk.dg.user\", defaultValue = \"developer\")\n    private String datagridUsername;\n\t@PropertyInject(\"com.redhat.bobbycar.camelk.dg.password\")\n    private String datagridPassword;\n\t\n\t@Override\n\tpublic void configure() throws Exception {\n\t\tbindToRegistry(\"cacheContainerConfiguration\", getCacheConfig());\n\t\t\n\t\tfrom(\"kafka:{{com.redhat.bobbycar.camelk.kafka.topic}}?clientId=kafkaToDatagridCamelClient&brokers={{com.redhat.bobbycar.camelk.kafka.brokers}}:9092\")\n\t\t\t.setHeader(InfinispanConstants.OPERATION).constant(InfinispanOperation.PUT)\n\t\t\t.setHeader(InfinispanConstants.KEY).expression(jsonpath(\"$.carid\"))\n\t\t\t/*.process((ex) -> {\n\t\t\t\tSystem.out.println(ex.getIn().getBody().getClass());\n\t\t\t\tex.getIn().setBody(ex.getIn().getBody().toString());\n\t\t\t\tex.getIn().setBody(\"{\\\"_type\\\":\\\"Car\\\",\" + ex.getIn().getBody().toString().substring(1));\n\t\t\t})*/\n\t\t    .setHeader(InfinispanConstants.VALUE).expression(simple(\"${body}\"))\n\t\t    \n\t\t    .log(\"Saving data to cache with key: ${headers[CamelInfinispanKey]} and value: ${body} of type  ${body.class}\")\n\t\t\t.to(\"infinispan://{{com.redhat.bobbycar.camelk.dg.cacheName}}?cacheContainerConfiguration=#cacheContainerConfiguration\");\n\t}\n\t\n\tprivate Configuration getCacheConfig() throws Exception {\n\t\tConfigurationBuilder hotRodBuilder = new ConfigurationBuilder();\n\n\t\treturn hotRodBuilder.addServer()\n\t        .host(datagridHost).port(11222)\n\t        \t.marshaller(new StringMarshaller(Charset.defaultCharset()))\n\t        \t//.marshaller(new ProtoStreamMarshaller())\n\t        .clientIntelligence(ClientIntelligence.BASIC)\n\t        \t.security()\n\t        \t\t.authentication().enable()\n\t        \t\t.username(datagridUsername)\n\t        \t\t.password(datagridPassword)\n\t        \t\t.realm(\"default\")\n\t        \t\t.serverName(\"infinispan\")\n\t        \t\t.saslQop(SaslQop.AUTH)\n\t        \t\t.saslMechanism(\"DIGEST-MD5\")\n\t        \t\t\n\t\t\t.ssl()\n\t        \t.sniHostName(datagridHost)\n\t        \t.trustStorePath(\"/var/run/secrets/kubernetes.io/serviceaccount/service-ca.crt\")\n        .build();\n\t}\n\t\n}\n"
      name: KafkaToDatagridRoute.java
